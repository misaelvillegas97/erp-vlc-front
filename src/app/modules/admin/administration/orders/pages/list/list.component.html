<div *transloco="let t; read: 'operations.orders'" class="flex flex-col min-w-0 w-full">
    <page-header
        [description]="t('list.subtitle')"
        [subtitle]="t('list.title')">
    </page-header>

    <div class="flex flex-col items-center justify-center w-full max-w-xs sm:max-w-screen-xl mx-auto py-10 gap-y-4 sm:px-4">
        <div class="flex flex-row w-full">
            <!-- Title -->
            <h2 class="flex-1 font-bold text-secondary text-xl self-center">{{ t('title') }}</h2>

            <!-- New member button -->
            <a
                [matTooltip]="t('new.title')"
                [routerLink]="['new']"
                class="flex-0 font-bold py-2 px-4 rounded"
                color="primary"
                mat-icon-button
            >
                <mat-icon svgIcon="heroicons_outline:plus"></mat-icon>
            </a>
        </div>

        <table
            [dataSource]="orders()"
            class="min-w-240 w-full overflow-y-visible bg-transparent"
            mat-table
            matSort
        >
            <!-- Order number -->
            <ng-container matColumnDef="orderNumber" sticky>
                <th *matHeaderCellDef mat-header-cell>Número de orden</th>
                <td *matCellDef="let order" mat-cell>
                    <span class="flex items-center">
                        <span class="font-medium text-sm">{{ order?.orderNumber }}</span>
                    </span>
                </td>
            </ng-container>

            <!-- Order number filter -->
            <ng-container matColumnDef="orderNumberFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <input (keyup.enter)="filterOrders()" (ngModelChange)="orderNumberFilter.set($event)" [ngModel]="orderNumberFilter()" matInput type="number">
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- Client fantasy name -->
            <ng-container matColumnDef="businessName">
                <th *matHeaderCellDef mat-header-cell>Cliente</th>
                <td *matCellDef="let order" mat-cell>
                    <span class="font-medium text-sm">{{ order?.client?.fantasyName }}</span>
                </td>
            </ng-container>

            <!-- Client fantasy name filter -->
            <ng-container matColumnDef="businessNameFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <input (keyup.enter)="filterOrders()" (ngModelChange)="businessNameFilter.set($event)" [ngModel]="businessNameFilter()" matInput>
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- Order type -->
            <ng-container matColumnDef="type">
                <th *matHeaderCellDef mat-header-cell>Tipo de orden</th>
                <td *matCellDef="let order" mat-cell>
                    @switch (order?.type) {
                        @case ('PURCHASE_ORDER') {
                            <span class="text-green text-sm">Orden de compra</span>
                        }
                        @case ('RETURN_ORDER') {
                            <span class="text-red text-sm">Orden de devolución</span>
                        }
                        @default {
                            <span class="text-blue text-sm">Estado desconocido</span>
                        }
                    }
                </td>
            </ng-container>

            <!-- Order type filter -->
            <ng-container matColumnDef="typeFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <mat-select (closed)="filterOrders()" (ngModelChange)="typeFilter.set($event)" [ngModel]="typeFilter()" multiple>
                            <mat-option value="PURCHASE_ORDER">Orden de compra</mat-option>
                            <mat-option value="RETURN_ORDER">Orden de devolución</mat-option>
                        </mat-select>
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="status">
                <th *matHeaderCellDef mat-header-cell>Estado</th>
                <td *matCellDef="let order" mat-cell>
                    @switch (order?.status) {
                        @case ('PENDING') {
                            <span class="text-yellow-500 text-sm">Pendiente</span>
                        }
                        @case ('IN_PROGRESS') {
                            <span class="text-blue-500 text-sm">En progreso</span>
                        }
                        @case ('READY_FOR_SHIPPING') {
                            <span class="text-yellow-500 text-sm">Listo para envío</span>
                        }
                        @case ('SHIPPED') {
                            <span class="text-green text-sm">Enviado</span>
                        }
                        @case ('IN_TRANSIT') {
                            <span class="text-blue-500 text-sm">En tránsito</span>
                        }
                        @case ('DELIVERED') {
                            <span class="text-green text-sm">Entregado</span>
                        }
                        @case ('CANCELED') {
                            <span class="text-red text-sm">Cancelado</span>
                        }
                    }
                </td>
            </ng-container>

            <!-- Status filter -->
            <ng-container matColumnDef="statusFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <mat-select (closed)="filterOrders()" (ngModelChange)="statusFilter.set($event)" [ngModel]="statusFilter()" multiple>
                            <mat-option value="PENDING">Pendiente</mat-option>
                            <mat-option value="IN_PROGRESS">En progreso</mat-option>
                            <mat-option value="READY_FOR_SHIPPING">Listo para envío</mat-option>
                            <mat-option value="SHIPPED">Enviado</mat-option>
                            <mat-option value="DELIVERED">Entregado</mat-option>
                            <mat-option value="CANCELED">Cancelado</mat-option>
                        </mat-select>
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- Delivery location -->
            <ng-container matColumnDef="deliveryLocation">
                <th *matHeaderCellDef mat-header-cell>Ubicación de entrega</th>
                <td *matCellDef="let order" mat-cell>
                    <span [title]="order?.deliveryLocation" class="text-sm line-clamp-1">{{ order?.deliveryLocation }}</span>
                </td>
            </ng-container>

            <!-- Delivery location filter -->
            <ng-container matColumnDef="deliveryLocationFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <input (keyup.enter)="filterOrders()" (ngModelChange)="deliveryLocationFilter.set($event)" [ngModel]="deliveryLocationFilter()" matInput>
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- Emission date -->
            <ng-container matColumnDef="emissionDate">
                <th *matHeaderCellDef mat-header-cell mat-sort-header>Fecha de emisión</th>
                <td *matCellDef="let order" mat-cell>
                    <span class="text-sm">{{ order?.emissionDate }}</span>
                </td>
            </ng-container>

            <!-- Emission date filter -->
            <ng-container matColumnDef="emissionDateFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <input (keyup.enter)="filterOrders()" (ngModelChange)="emissionDateFilter.set($event)" [ngModel]="emissionDateFilter()" matInput>
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- DeliveryDate -->
            <ng-container matColumnDef="deliveryDate">
                <th *matHeaderCellDef mat-header-cell mat-sort-header>Fecha de entrega</th>
                <td *matCellDef="let order" mat-cell>
                    <span class="text-sm">{{ order?.deliveryDate }}</span>
                </td>
            </ng-container>

            <!-- DeliveryDate filter -->
            <ng-container matColumnDef="deliveryDateFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <input (keyup.enter)="filterOrders()" (ngModelChange)="deliveryDateFilter.set($event)" [ngModel]="deliveryDateFilter()" matInput>
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- Amount -->
            <ng-container matColumnDef="amount">
                <th *matHeaderCellDef mat-header-cell>Monto</th>
                <td *matCellDef="let order" mat-cell>
                    <span class="text-sm">{{ order?.totalAmount | currency: 'CLP':'symbol-narrow' }}</span>
                </td>
            </ng-container>

            <!-- Amount filter -->
            <ng-container matColumnDef="amountFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <input (keyup.enter)="filterOrders()" (ngModelChange)="amountFilter.set($event)" [ngModel]="amountFilter()" matInput>
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- Invoice -->
            <ng-container matColumnDef="invoice">
                <th *matHeaderCellDef mat-header-cell>Factura</th>
                <td *matCellDef="let order" mat-cell>
                    @if (order?.invoice) {
                        <span class="text-sm">{{ order?.invoice?.number }}</span>
                    } @else {
                        <div class="flex-center">
                            <button mat-icon-button (click)="openAddInvoiceDialog(order)">
                                <mat-icon svgIcon="heroicons_outline:plus" class="icon-size-5"></mat-icon>
                            </button>
                        </div>
                    }
                </td>
            </ng-container>

            <!-- Invoice filter -->
            <ng-container matColumnDef="invoiceFilter">
                <th *matHeaderCellDef mat-header-cell>
                    <mat-form-field class="fuse-mat-dense" subscriptSizing="dynamic">
                        <input (keyup.enter)="filterOrders()" (ngModelChange)="invoiceFilter.set($event)" [ngModel]="invoiceFilter()" matInput>
                    </mat-form-field>
                </th>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
                <th *matHeaderCellDef mat-header-cell></th>
                <td *matCellDef="let order" mat-cell>
                    <button [matTooltip]="'Ver orden'" [routerLink]="['view', order.id]" mat-icon-button>
                        <mat-icon svgIcon="heroicons_outline:eye"></mat-icon>
                    </button>
                </td>
            </ng-container>

            <!-- Actions filter -->
            <ng-container matColumnDef="actionsFilter">
                <th *matHeaderCellDef mat-header-cell></th>
            </ng-container>

            <tr *matHeaderRowDef="displayedColumns" class="bg-white/25 dark:bg-gray-800/25" mat-header-row></tr>
            <tr *matHeaderRowDef="displayedFilterColumns" class="bg-white/25 dark:bg-gray-800/25" mat-header-row></tr>
            <tr *matRowDef="let row; columns: displayedColumns" mat-row></tr>

            <!-- No data -->
            <tr *matNoDataRow class="h-16">
                <td [attr.colspan]="displayedColumns.length" class="text-center italic mat-hint">
                    No hay órdenes disponibles para mostrar
                </td>
            </tr>
        </table>
    </div>
</div>
