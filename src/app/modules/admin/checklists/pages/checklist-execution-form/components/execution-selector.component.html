<div class="flex flex-col min-w-0 w-full">
    <page-header
        title="Seleccionar Checklist"
        subtitle="Elige una plantilla o grupo de checklists para ejecutar">
    </page-header>

    <div class="flex flex-col items-center justify-center w-full max-w-xs sm:max-w-6xl mx-auto py-10 gap-y-6 sm:px-4">

        <!-- Header -->
        <div class="flex flex-row w-full items-center gap-4">
            <div class="flex-1">
                <h2 class="font-bold text-secondary text-xl">Ejecutar Checklist</h2>
                <p class="text-sm text-gray-600 dark:text-gray-300">
                    Selecciona una plantilla individual o un grupo completo de checklists para ejecutar
                </p>
            </div>
        </div>

        <!-- Execution Type Selection -->
        <div class="w-full bg-card rounded-md shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Tipo de Ejecución</h3>

            <mat-radio-group [formControl]="executionTypeControl" class="flex gap-6">
                <mat-radio-button value="template" class="flex-1">
                    <div class="flex items-center gap-3">
                        <mat-icon class="text-blue-500 dark:text-blue-400">assignment</mat-icon>
                        <div>
                            <div class="font-medium">Plantilla Individual</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300">Ejecutar una plantilla específica</div>
                        </div>
                    </div>
                </mat-radio-button>

                <mat-radio-button value="group" class="flex-1">
                    <div class="flex items-center gap-3">
                        <mat-icon class="text-green-500 dark:text-green-400">group_work</mat-icon>
                        <div>
                            <div class="font-medium">Grupo de Plantillas</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300">Ejecutar un grupo completo</div>
                        </div>
                    </div>
                </mat-radio-button>
            </mat-radio-group>
        </div>

        <!-- Filters Section -->
        <div class="w-full bg-card rounded-md shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Filtros</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <mat-form-field class="w-full">
                    <mat-label>Buscar</mat-label>
                    <input matInput [formControl]="searchControl" placeholder="Buscar por nombre">
                    <mat-icon matSuffix svgIcon="heroicons_outline:magnifying-glass"></mat-icon>
                </mat-form-field>

                @if (executionTypeSignal() === 'template') {
                    <mat-form-field class="w-full">
                        <mat-label>Vehículos</mat-label>
                        <mat-select [formControl]="vehicleFilterControl" multiple>
                            @for (vehicle of availableVehicles(); track vehicle.id) {
                                <mat-option [value]="vehicle.id">{{ vehicle.name }} - {{ vehicle.plate }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Roles</mat-label>
                        <mat-select [formControl]="roleFilterControl" multiple>
                            @for (role of availableRoles(); track role.id) {
                                <mat-option [value]="role.id">{{ role.name }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                }
            </div>

            <div class="flex justify-end mt-4">
                <button mat-button color="warn" (click)="clearSelection()">
                    Limpiar Filtros
                </button>
            </div>
        </div>

        <!-- Templates List -->
        @if (executionTypeSignal() === 'template') {
            <div class="w-full bg-card rounded-md shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Plantillas Disponibles</h3>

                @if (filteredTemplates().length === 0) {
                    <div class="text-center py-8">
                        <mat-icon class="text-gray-400 dark:text-gray-500 text-4xl mb-2">assignment</mat-icon>
                        <p class="text-gray-600 dark:text-gray-300">No hay plantillas disponibles con los filtros seleccionados</p>
                    </div>
                } @else {
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        @for (template of filteredTemplates(); track template.id) {
                            <div class="border dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors"
                                 [class.ring-2]="selectedTemplateOrGroup()?.id === template.id"
                                 [class.ring-blue-500]="selectedTemplateOrGroup()?.id === template.id"
                                 (click)="selectTarget(template)">

                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h4 class="font-medium text-gray-900 dark:text-gray-100">{{ template.name }}</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-300">{{ template.type | titlecase }} • v{{ template.version }}</p>
                                    </div>
                                    @if (selectedTemplateOrGroup()?.id === template.id) {
                                        <mat-icon class="text-blue-500 dark:text-blue-400">check_circle</mat-icon>
                                    }
                                </div>

                                @if (template.description) {
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">{{ template.description }}</p>
                                }

                                <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-300">
                                    <div class="flex items-center gap-4">
                                        <div class="flex items-center gap-1">
                                            <mat-icon class="text-xs">folder</mat-icon>
                                            <span>{{ template.categories?.length || 0 }} categorías</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <mat-icon class="text-xs">help_outline</mat-icon>
                                            <span>{{ getTotalQuestions(template) }} preguntas</span>
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-1">
                    <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded text-xs">
                      {{ (template.weight * 100).toFixed(0) }}%
                    </span>
                                    </div>
                                </div>

                                <div class="mt-3 pt-3 border-t dark:border-gray-600">
                                    <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                                        <mat-icon class="text-xs">directions_car</mat-icon>
                                        <span>{{ template.vehicleTypes?.length || 0 }} vehículos</span>
                                        <mat-icon class="text-xs">person</mat-icon>
                                        <span>{{ template.userRoles?.length || 0 }} roles</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- Groups List -->
        @if (executionTypeSignal() === 'group') {
            <div class="w-full bg-card rounded-md shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Grupos Disponibles</h3>

                @if (filteredGroups().length === 0) {
                    <div class="text-center py-8">
                        <mat-icon class="text-gray-400 dark:text-gray-500 text-4xl mb-2">group_work</mat-icon>
                        <p class="text-gray-600 dark:text-gray-300">No hay grupos disponibles con los filtros seleccionados</p>
                    </div>
                } @else {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        @for (group of filteredGroups(); track group.id) {
                            <div class="border dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors"
                                 [class.ring-2]="selectedTemplateOrGroup()?.id === group.id"
                                 [class.ring-green-500]="selectedTemplateOrGroup()?.id === group.id"
                                 (click)="selectTarget(group)">

                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h4 class="font-medium text-gray-900 dark:text-gray-100">{{ group.name }}</h4>
                                        <div class="flex items-center gap-2 mt-1">
                      <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 rounded text-xs">
                        {{ (group.weight * 100).toFixed(0) }}% peso
                      </span>
                                        </div>
                                    </div>
                                    @if (selectedTemplateOrGroup()?.id === group.id) {
                                        <mat-icon class="text-green-500 dark:text-green-400">check_circle</mat-icon>
                                    }
                                </div>

                                @if (group.description) {
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">{{ group.description }}</p>
                                }

                                <div class="space-y-2">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-600 dark:text-gray-300">Plantillas incluidas:</span>
                                        <span class="font-medium">{{ group.templates?.length || 0 }}</span>
                                    </div>

                                    @if (group.templates && group.templates.length > 0) {
                                        <div class="space-y-1">
                                            @for (template of group.templates.slice(0, 3); track template.id) {
                                                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                                                    <mat-icon class="text-xs">assignment</mat-icon>
                                                    <span>{{ template.name }}</span>
                                                    <span class="ml-auto">{{ (template.weight * 100).toFixed(0) }}%</span>
                                                </div>
                                            }
                                            @if (group.templates.length > 3) {
                                                <div class="text-xs text-gray-400 dark:text-gray-500">
                                                    +{{ group.templates.length - 3 }} más...
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- Selected Item Summary -->
        @if (selectedTemplateOrGroup()) {
            <div class="w-full bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md p-6">
                <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-4">Selección Actual</h3>

                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h4 class="font-medium text-blue-900 dark:text-blue-100">{{ selectedTemplateOrGroup()!.name }}</h4>
                        <p class="text-sm text-blue-700 dark:text-blue-300 mt-1">
                            @if (isSelectedItemGroup()) {
                                Grupo con {{ selectedTemplateOrGroup()!.templates?.length || 0 }} plantillas
                            } @else {
                                Plantilla individual • {{ getTotalQuestions(selectedTemplateOrGroup()!) }} preguntas
                            }
                        </p>

                        @if (selectedTemplateOrGroup()!.description) {
                            <p class="text-sm text-blue-600 mt-2">{{ selectedTemplateOrGroup()!.description }}</p>
                        }
                    </div>

                    <button mat-icon-button (click)="clearSelection()" [matTooltip]="'Limpiar selección'">
                        <mat-icon class="text-blue-700">close</mat-icon>
                    </button>
                </div>
            </div>
        }

        <!-- Action Buttons -->
        <div class="flex justify-end gap-4 w-full pt-6">
            <button mat-button routerLink="../">
                Cancelar
            </button>

            <button
                mat-raised-button
                color="primary"
                [disabled]="!selectedTemplateOrGroup()"
                (click)="startExecution()">
                <mat-icon>play_arrow</mat-icon>
                Iniciar Ejecución
            </button>
        </div>
    </div>
</div>
