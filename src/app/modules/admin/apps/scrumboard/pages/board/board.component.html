<!-- Trello-like Board Container with Blurred Background -->
<div class="absolute inset-0 flex min-w-0 flex-col overflow-hidden bg-gradient-to-br from-blue-600 via-purple-600 to-blue-800">
    <!-- Background Image with Blur Effect -->
    <div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-30 blur-sm"
         style="background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');">
    </div>
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-center justify-between p-6 sm:py-4 sm:px-6 border-b bg-card dark:bg-transparent">
        <!-- Board title and description -->
        <div class="flex items-center">
            <div class="flex flex-col">
                <div class="text-2xl font-semibold">{{ board()?.title }}</div>
                <div class="text-secondary">{{ board()?.description }}</div>
            </div>
        </div>

        <!-- Board actions -->
        <div class="flex items-center mt-4 sm:mt-0">
            <!-- Board members -->
            <div class="flex items-center -space-x-1.5 mr-4">
                @for (member of board()?.members; track member.id) {
                    <img
                        class="w-8 h-8 rounded-full ring-2 ring-bg-card"
                        [src]="member.avatar"
                        [alt]="member.name"
                        [matTooltip]="member.name">
                }
            </div>

            <!-- Add member button -->
            <button
                class="ml-2"
                mat-icon-button
                [matTooltip]="'Add member'">
                <mat-icon [svgIcon]="'heroicons_outline:user-plus'"></mat-icon>
            </button>

            <!-- Board settings -->
            <button
                class="ml-2"
                mat-icon-button
                [matMenuTriggerFor]="boardMenu">
                <mat-icon [svgIcon]="'heroicons_outline:cog'"></mat-icon>
            </button>
            <mat-menu #boardMenu="matMenu">
                <button mat-menu-item>
                    <mat-icon [svgIcon]="'heroicons_outline:pencil'"></mat-icon>
                    <span>Edit Board</span>
                </button>
                <button mat-menu-item>
                    <mat-icon [svgIcon]="'heroicons_outline:photo'"></mat-icon>
                    <span>Change Background</span>
                </button>
                <button mat-menu-item>
                    <mat-icon [svgIcon]="'heroicons_outline:archive-box'"></mat-icon>
                    <span>Archive Board</span>
                </button>
                <button mat-menu-item>
                    <mat-icon [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                    <span>Delete Board</span>
                </button>
            </mat-menu>
        </div>
    </div>
    <div class="relative z-10 flex flex-0 flex-col backdrop-blur-md bg-white/10 border-b border-white/20 p-6 sm:flex-row sm:items-center sm:justify-between sm:px-10 sm:py-8">
        <!-- Title -->
        <div class="min-w-0 flex-1 space-x-4 flex">
            <a [routerLink]="'../'" mat-icon-button>
                <mat-icon [svgIcon]="'heroicons_outline:chevron-left'"></mat-icon>
            </a>
            <h2 class="truncate text-3xl font-extrabold leading-7 tracking-tight sm:leading-10 md:text-4xl text-white drop-shadow-lg">
                {{ boardTitle() }}
            </h2>
        </div>
        <!-- Actions -->
        <div class="mt-6 flex shrink-0 items-center sm:ml-4 sm:mt-0">
            <a [routerLink]="['./..']" mat-stroked-button>
                <mat-icon
                    [svgIcon]="'heroicons_solid:view-columns'"
                    class="icon-size-5"
                ></mat-icon>
                <span class="ml-2">Tableros</span>
            </a>
            <a [routerLink]="['./settings']" class="ml-3" mat-stroked-button>
                <mat-icon
                    [svgIcon]="'heroicons_solid:cog-8-tooth'"
                    class="icon-size-5"
                ></mat-icon>
                <span class="ml-2">Configuraci√≥n</span>
            </a>
        </div>
    </div>

    <!-- Main -->
    <div cdkScrollable class="relative z-10 flex-auto overflow-y-auto p-6 sm:p-8 sm:pt-4">
        <!-- Lists -->
        <div
            (cdkDropListDropped)="listDropped($event)"
            [cdkDropListData]="boardLists()"
            [cdkDropListOrientation]="'horizontal'"
            cdkDropList
            class="flex overflow-x-auto pb-4"
            style="scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent;"
        >
            <!-- Group all cdkDropList's after this point together so that the cards can be transferred between lists -->
            <div cdkDropListGroup class="flex items-start space-x-4">
                <!-- List -->
                @for (list of boardLists(); track list.id) {
                    <div class="w-72 flex-0 rounded-xl p-3 backdrop-blur-sm bg-white/90 dark:bg-gray-800/90 shadow-lg border border-white/20 dark:border-gray-600/20 min-h-fit transition-all duration-200 hover:shadow-xl hover:scale-[1.02]"
                         [style.background-color]="list.color ? list.color + '90' : 'rgba(255,255,255,0.9)'"
                         cdkDrag
                         cdkDragPreviewClass="list-drag-preview"
                         cdkDragPlaceholderClass="list-drag-placeholder">
                        <div class="flex items-center justify-between" cdkDragHandle>
                            <div class="flex w-full cursor-text items-center rounded-lg border border-transparent px-3 py-2 focus-within:border-blue-500 focus-within:bg-white/95 dark:focus-within:bg-gray-700/95 focus-within:shadow-md transition-all duration-200">
                                @if (list.icon) {
                                    <mat-icon class="mr-2 text-current" [svgIcon]="list.icon"></mat-icon>
                                }
                                <input
                                    class="w-full bg-transparent font-medium leading-5"
                                    [spellcheck]="'false'"
                                    [value]="list.title"
                                    (focusout)="updateListTitle($event, list)"
                                    (keydown.enter)="listTitleInput.blur()"
                                    #listTitleInput
                                />
                            </div>
                            <div class="ml-4 flex min-w-6 items-center justify-center rounded-full bg-gray-500/20 dark:bg-gray-400/20 text-gray-700 dark:text-gray-300 text-sm font-semibold leading-6 backdrop-blur-sm">
                                {{ list.cards.length }}
                            </div>
                            <div class="ml-1">
                                <button class="h-8 min-h-8 w-8" mat-icon-button [matMenuTriggerFor]="listMenu">
                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:ellipsis-vertical'"></mat-icon>
                                </button>
                                <mat-menu #listMenu="matMenu">
                                    <button mat-menu-item (click)="renameList(listTitleInput)">
                                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:pencil-square'"></mat-icon>
                                        Renombrar lista
                                    </button>
                                    <button mat-menu-item (click)="editListProperties(list)">
                                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:cog'"></mat-icon>
                                        Personalizar lista
                                    </button>
                                    <button mat-menu-item color="warn" (click)="deleteList(list.id)">
                                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:trash'"></mat-icon>
                                        Eliminar lista
                                    </button>
                                </mat-menu>
                            </div>
                        </div>

                        <!-- Cards -->
                        <div class="mt-3 rounded-lg bg-black/5 backdrop-blur-sm border border-white/10">
                            <div
                                class="p-3 pb-0 min-h-22 rounded-lg"
                                cdkDropList
                                [id]="list.id"
                                [cdkDropListData]="list.cards"
                                (cdkDropListDropped)="cardDropped($event)"
                                cdkDropListSortingDisabled="false"
                            >
                                <!-- Card -->
                                @for (card of list.cards; track card.id) {
                                    <div cdkDrag
                                         cdkDragPreviewClass="card-drag-preview"
                                         cdkDragPlaceholderClass="card-drag-placeholder">
                                        <a
                                            class="bg-white dark:bg-gray-800 mb-3 flex flex-col items-start space-y-3 overflow-hidden rounded-lg p-4 shadow-sm hover:shadow-md transition-all hover:scale-[1.02] border border-gray-200/50 dark:border-gray-600/50 backdrop-blur-sm cursor-grab active:cursor-grabbing"
                                            [routerLink]="['card', card.id]"
                                        >
                                            <!-- Cover image -->
                                            @if (card.coverImage) {
                                                <div class="-mx-4 -mt-4 mb-2">
                                                    <img class="w-full h-32 object-cover rounded-t-lg" [src]="card.coverImage"/>
                                                </div>
                                            }

                                            <!-- Card type badge (if available) -->
                                            @if (card.type) {
                                                <div class="absolute top-2 right-2 px-2 py-1 text-xs font-semibold rounded-md backdrop-blur-sm"
                                                     [class.bg-blue-100]="card.type === 'task'"
                                                     [class.text-blue-800]="card.type === 'task'"
                                                     [class.bg-red-100]="card.type === 'bug'"
                                                     [class.text-red-800]="card.type === 'bug'"
                                                     [class.bg-yellow-100]="card.type === 'note'"
                                                     [class.text-yellow-800]="card.type === 'note'"
                                                     [class.bg-green-100]="card.type === 'feature'"
                                                     [class.text-green-800]="card.type === 'feature'">
                                                    {{ card.type }}
                                                </div>
                                            }

                                            <!-- Title -->
                                            <div class="text-lg font-medium leading-5">
                                                {{ card.title }}
                                            </div>

                                            <!-- Activity icons -->
                                            <div class="flex items-center space-x-2">
                                                @if (card.checklists?.length) {
                                                    <div class="flex items-center text-gray-500 dark:text-gray-400"
                                                         [matTooltip]="getChecklistCompletionText(card)">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:check-circle'"></mat-icon>
                                                        <span class="ml-1 text-xs">{{ getChecklistCompletion(card) }}</span>
                                                    </div>
                                                }

                                                @if (card.comments?.length) {
                                                    <div class="flex items-center text-gray-500 dark:text-gray-400"
                                                         [matTooltip]="card.comments.length + ' comments'">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:chat-bubble-left-right'"></mat-icon>
                                                        <span class="ml-1 text-xs">{{ card.comments.length }}</span>
                                                    </div>
                                                }

                                                @if (card.attachments?.length) {
                                                    <div class="flex items-center text-gray-500 dark:text-gray-400"
                                                         [matTooltip]="card.attachments.length + ' attachments'">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:paper-clip'"></mat-icon>
                                                        <span class="ml-1 text-xs">{{ card.attachments.length }}</span>
                                                    </div>
                                                }

                                                @if (card.dueDate) {
                                                    <div
                                                        class="flex items-center text-sm"
                                                        [class.text-gray-500]="!isOverdue(card.dueDate)"
                                                        [class.text-red-600]="isOverdue(card.dueDate)"
                                                        [matTooltip]="'Vencimiento: ' + (card.dueDate | date: 'longDate')"
                                                    >
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:clock'"></mat-icon>
                                                    </div>
                                                }
                                            </div>

                                            <!-- Labels -->
                                            @if (card.labels.length) {
                                                <div class="flex flex-wrap gap-1 mb-2">
                                                    @for (label of card.labels; track label.id) {
                                                        <div
                                                            class="w-8 h-2 rounded"
                                                            [style.background-color]="label.color">
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            <!-- Assignees avatars -->
                                            @if (card.assignees.length) {
                                                <div class="flex items-center -space-x-2">
                                                    @for (assignee of card.assignees; track assignee.id) {
                                                        @if (assignee.avatar) {
                                                            <img
                                                                class="w-6 h-6 rounded-full border-2 border-white"
                                                                [src]="assignee.avatar.fileUrl"
                                                                [alt]="assignee.name"
                                                                [matTooltip]="assignee.name"
                                                            />
                                                        } @else {
                                                            <div
                                                                class="w-6 h-6 rounded-full border-2 border-white bg-gray-300 text-sm font-medium leading-6 flex items-center justify-center"
                                                                [matTooltip]="assignee.name"
                                                            >
                                                                {{ assignee?.name.charAt(0) }}
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        </a>
                                    </div>
                                }
                            </div>

                            <!-- New card -->
                            <scrumboard-board-add-card
                                (saved)="addCard(list, $event)"
                                [buttonTitle]=" list.cards.length ? 'Agregar otra tarjeta' : 'Agregar una tarjeta'"
                            >
                            </scrumboard-board-add-card>
                        </div>
                    </div>
                }

                <!-- New list -->
                <scrumboard-board-add-list
                    (saved)="addList($event)"
                    [buttonTitle]=" board()?.lists.length ? 'Agregar otra lista' : 'Agregar una lista'"
                >
                </scrumboard-board-add-list>
            </div>
        </div>
    </div>
</div>

<!-- Invisible router-outlet for ScrumboardCard component -->
<div class="pointer-events-none invisible absolute h-0 w-0 opacity-0">
    <router-outlet></router-outlet>
</div>
