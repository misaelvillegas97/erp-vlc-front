# global options
{
    admin off
    persist_config off
    auto_https off
    log { format json }
    servers { trusted_proxies static private_ranges }
}

:{$PORT} {
    log {
        format json
        output stdout
    }

    # API
    handle /api/* {
        reverse_proxy erp-vlc-back:8080 {
            transport http { versions h1c }
        }
    }

    # Health
    respond /health 200

    # --- Frontend est√°tico ---
    root * /dist
    encode gzip

    # 1) NUNCA cachear HTML (incluye /index.html)
    @html path_regexp html \.html$
    header @html {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }

    # 2) NUNCA cachear archivos del Service Worker
    @sw path /ngsw.json /ngsw-worker.js /ngsw-state.js /safety-worker.js /worker-basic.min.js
    header @sw {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }

    # 3) Cache agresivo solo para assets con hash
    @assets path_regexp assets \.(?:js|css|woff2?|svg|png|jpg|webp|ico)$
    header @assets {
        Cache-Control "public, max-age=31536000, immutable"
    }

    # 4) SPA fallback: primero reescribe, luego sirve archivos
    try_files {path} /index.html
    file_server
}
